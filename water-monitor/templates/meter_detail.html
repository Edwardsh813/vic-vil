{% extends "base.html" %}

{% block title %}{{ account.building_name }} Unit {{ account.unit_number }} - Water Monitor{% endblock %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
    <a href="{{ url_for('dashboard') }}">&larr; Back to Dashboard</a>
</div>

<h2 style="margin-bottom: 1.5rem;">
    {{ account.building_name or 'Unknown Building' }} - Unit {{ account.unit_number or 'N/A' }}
</h2>

<div class="stats">
    <div class="stat-card">
        <div class="label">Today's Usage</div>
        <div class="value">
            {% if daily_data and daily_data[0].reading_date == today %}
                {{ "%.1f"|format(daily_data[0].total_usage_gallons or 0) }} gal
            {% else %}
                -- gal
            {% endif %}
        </div>
    </div>
    <div class="stat-card">
        <div class="label">7-Day Average</div>
        <div class="value">
            {% set week_total = daily_data[:7]|sum(attribute='total_usage_gallons') %}
            {{ "%.1f"|format(week_total / 7) if daily_data else '--' }} gal
        </div>
    </div>
    <div class="stat-card">
        <div class="label">30-Day Total</div>
        <div class="value">
            {% set month_total = daily_data|sum(attribute='total_usage_gallons') %}
            {{ "%.0f"|format(month_total) if daily_data else '--' }} gal
        </div>
    </div>
</div>

<div class="card">
    <h2>Today's Hourly Usage</h2>
    {% if hourly_data %}
    <div style="display: flex; align-items: flex-end; height: 200px; gap: 4px; padding: 1rem 0;">
        {% set max_hourly = hourly_data|map(attribute='usage_gallons')|max or 1 %}
        {% for hour in hourly_data %}
        <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
            <div style="background: #2563eb; width: 100%;
                        height: {{ (hour.usage_gallons or 0) / max_hourly * 150 }}px;
                        border-radius: 4px 4px 0 0;"></div>
            <div style="font-size: 0.7rem; color: #6b7280; margin-top: 4px;">{{ hour.hour }}</div>
        </div>
        {% endfor %}
    </div>
    <p class="text-muted">Hours (0-23)</p>
    {% else %}
    <p class="text-muted">No hourly data available for today.</p>
    {% endif %}
</div>

<div class="card">
    <h2>Daily Usage History</h2>

    <form method="GET" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="start_date">From</label>
            <input type="date" id="start_date" name="start_date" value="{{ start_date }}">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
            <label for="end_date">To</label>
            <input type="date" id="end_date" name="end_date" value="{{ end_date }}">
        </div>
        <div class="form-group" style="margin-bottom: 0; display: flex; align-items: flex-end;">
            <button type="submit" class="btn btn-primary">Update</button>
        </div>
    </form>

    {% if daily_data %}
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Usage (gal)</th>
                <th>Peak Hour</th>
                <th>Peak Usage</th>
            </tr>
        </thead>
        <tbody>
            {% for day in daily_data %}
            <tr>
                <td>{{ day.reading_date }}</td>
                <td>{{ "%.1f"|format(day.total_usage_gallons or 0) }}</td>
                <td>{{ day.peak_hour if day.peak_hour is not none else '-' }}{% if day.peak_hour is not none %}:00{% endif %}</td>
                <td>{{ "%.1f"|format(day.peak_usage_gallons or 0) if day.peak_usage_gallons else '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No usage data available for this period.</p>
    {% endif %}
</div>

<div class="card">
    <h2>Account Details</h2>
    <table>
        <tr><td><strong>Email</strong></td><td>{{ account.email }}</td></tr>
        <tr><td><strong>Meter ID</strong></td><td>{{ account.meter_id or 'Not set' }}</td></tr>
        <tr><td><strong>Last Scraped</strong></td><td>{{ account.last_scraped or 'Never' }}</td></tr>
    </table>
    <div class="mt-4">
        <a href="{{ url_for('edit_account', account_id=account.id) }}" class="btn btn-secondary">Edit Account</a>
    </div>
</div>
{% endblock %}
